
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://skhrg.github.io/megham/1.3.1/affine/">
      
      
        <link rel="prev" href="../joint_cpd/">
      
      
        <link rel="next" href="../reference/mds/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>Affine Transformation - Megham</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#computing-and-decomposing-the-affine-transformation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Megham" class="md-header__button md-logo" aria-label="Megham" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Megham
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Affine Transformation
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Megham" class="md-nav__button md-logo" aria-label="Megham" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Megham
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../joint_cpd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Joint CPD
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Affine Transformation
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Affine Transformation
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-affine-transformation" class="md-nav__link">
    <span class="md-ellipsis">
      The Affine Transformation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#method-1-the-svd-method" class="md-nav__link">
    <span class="md-ellipsis">
      Method 1: The SVD Method
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#method-2-weighted-least-squares" class="md-nav__link">
    <span class="md-ellipsis">
      Method 2: Weighted Least Squares
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decomposing-the-affine-transformation" class="md-nav__link">
    <span class="md-ellipsis">
      Decomposing the Affine Transformation
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/mds/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    mds
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    registration
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            registration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/registration/cpd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    cpd
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/transform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    transform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-affine-transformation" class="md-nav__link">
    <span class="md-ellipsis">
      The Affine Transformation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#method-1-the-svd-method" class="md-nav__link">
    <span class="md-ellipsis">
      Method 1: The SVD Method
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#method-2-weighted-least-squares" class="md-nav__link">
    <span class="md-ellipsis">
      Method 2: Weighted Least Squares
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decomposing-the-affine-transformation" class="md-nav__link">
    <span class="md-ellipsis">
      Decomposing the Affine Transformation
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="computing-and-decomposing-the-affine-transformation">Computing and Decomposing the Affine Transformation</h1>
<h2 id="the-affine-transformation">The Affine Transformation</h2>
<p>The affine transformation is a supremely useful transformation that preserves collinearity and parallelism but nothing else.
This is useful in many scenarios where you which to remain in the linear regime while allowing as generic of a transformation as possible.
There are many places to learn the details of the transformation, but as usual <a href="https://en.wikipedia.org/wiki/Affine_transformation">Wikipedia</a> is a good starting place. </p>
<p>This repository contains a function, <a href="https://skhrg.github.io/megham/latest/reference/transform/#megham.transform.get_affine"><code>get_affine</code></a>, to compute this transform.
This page contains information on the two methods used in that function to compute this transformation.</p>
<p>Since the affine transformation is simply a generic linear transformation, we write it as follows:</p>
<div class="arithmatex">\[
y = Ax + b
\]</div>
<p>Where <span class="arithmatex">\(x\)</span> is the starting set of points, <span class="arithmatex">\(A\)</span> is a matrix representing the affine transformation, <span class="arithmatex">\(b\)</span> is a offset vector, and <span class="arithmatex">\(y\)</span> is the transformed set of points.
We will refer to the terms of this equation throughout this page.</p>
<h2 id="method-1-the-svd-method">Method 1: The SVD Method</h2>
<p>Using the SVD to compute the affine transform is incredibly useful when dealing with noisy or large datasets (or large noisy datasets).</p>
<p>To begin we first approximate <span class="arithmatex">\(b\)</span> by taking the mean or median of <span class="arithmatex">\(y - x\)</span>.
Then we build the following matrix:</p>
<div class="arithmatex">\[
M = \begin{bmatrix} x^T &amp; y^T \end{bmatrix}
\]</div>
<p>we then use the SVD to compute <span class="arithmatex">\(V^{\ast}\)</span>, the right singular vectors of <span class="arithmatex">\(M\)</span>.</p>
<p>Taking the two largest right singular vectors, <span class="arithmatex">\(V_{1}\)</span> and <span class="arithmatex">\(V_{2}\)</span> we define the following:</p>
<div class="arithmatex">\[
\begin{bmatrix} B \\ C \end{bmatrix} = \begin{bmatrix} V_{1} &amp; V_{2} \end{bmatrix}
\]</div>
<p>which then gives us the affine transformation <span class="arithmatex">\(A = CB^{-1}\)</span>.</p>
<p>This may seem like nonsense at first but its actually fairly intuitive method.
<span class="arithmatex">\(B\)</span> essentially is a description of <span class="arithmatex">\(x\)</span>'s column basis and <span class="arithmatex">\(C\)</span> the same for <span class="arithmatex">\(y\)</span>,
so <span class="arithmatex">\(CB^{^1}\)</span> takes us from the basis of <span class="arithmatex">\(x\)</span> to the singular basis and then to the basis of <span class="arithmatex">\(y\)</span>.
Given that <span class="arithmatex">\(x\)</span> and <span class="arithmatex">\(y\)</span> are <span class="arithmatex">\(n_{point}\)</span> by <span class="arithmatex">\(n_{dim}\)</span> matrices, the column basis describes the coordinate systems in which they live.</p>
<h2 id="method-2-weighted-least-squares">Method 2: Weighted Least Squares</h2>
<p>This method is much more straightforward to understand.
In the original equation <span class="arithmatex">\(y = Ax + b\)</span> we add an additional variable <span class="arithmatex">\(w\)</span> where <span class="arithmatex">\(w\)</span> is a per-point weight.
The equation now becomes:</p>
<div class="arithmatex">\[
\sqrt{2}y = A\sqrt{2}(x + b)
\]</div>
<p>In order to simplify this equation we split <span class="arithmatex">\(b\)</span> into two terms: <span class="arithmatex">\(b_{naive}\)</span> and <span class="arithmatex">\(b_{leastsq}\)</span>.
We solve for <span class="arithmatex">\(b_{naive}\)</span> simply by taking the mean or median of <span class="arithmatex">\(y - b\)</span> just as before.</p>
<p>Then to solve for <span class="arithmatex">\(b_{leastsq}\)</span> we define the following:</p>
<div class="arithmatex">\[
A' = \begin{bmatrix}A\\ b_{leastsq} \end{bmatrix}
\]</div>
<p>and</p>
<div class="arithmatex">\[
x' = \begin{bmatrix}\sqrt{w}x &amp; \mathbf{1} \end{bmatrix}
\]</div>
<p>where <span class="arithmatex">\(\mathbf{1}\)</span> is a vector of all ones.</p>
<p>Now we have:</p>
<div class="arithmatex">\[
\sqrt{w}\left(y - b_{naive}\right) = A'x'
\]</div>
<p>from which we can solve for <span class="arithmatex">\(A'\)</span>.</p>
<p>The analytic solution is simply:</p>
<div class="arithmatex">\[
A' = \sqrt{w}yx'^{-1}
\]</div>
<p>but direct inversion of <span class="arithmatex">\(x'\)</span> can be costly if it is a large array and can have numerical issues
if it has a poor condition number, so instead we use the standard <a href="https://numpy.org/doc/stable/reference/generated/numpy.linalg.lstsq.html">numpy function</a> to solve.</p>
<p>Then we can extract <span class="arithmatex">\(A\)</span> and <span class="arithmatex">\(b_{leastsq}\)</span> from <span class="arithmatex">\(A'\)</span> and sum up to get the full <span class="arithmatex">\(b = b_{naive} + b_{leastsq}\)</span>.</p>
<h2 id="decomposing-the-affine-transformation">Decomposing the Affine Transformation</h2>
<p>Regardless of how we compute the affine transformation we often want to decompose it into a set of numbers which can then be understood.
The function <a href="https://skhrg.github.io/megham/latest/reference/transform/#megham.transform.decompose_affine"><code>decompose_affine</code></a> decomposes the affine transform into a scale term, a shear term, and a rotation matrix.
This decomposition is able to fully describe the transformation and offers values that are easy to interpret geometrically.</p>
<p>We define this decomposition as:</p>
<div class="arithmatex">\[
A = RSM
\]</div>
<p>where <span class="arithmatex">\(R\)</span> is the rotation matrix, <span class="arithmatex">\(S\)</span> is the shear matrix, and <span class="arithmatex">\(M\)</span> is the scale matrix.</p>
<p>Starting with the affine transform as a <span class="arithmatex">\(n_{dim}\)</span> by <span class="arithmatex">\(n_{dim}\)</span> matrix we take:</p>
<div class="arithmatex">\[
B = A^T A = M^T S^T R^T R S M = M^T S^T S M
\]</div>
<p><span class="arithmatex">\(B\)</span> is now the transform without the rotation term since the transpose of a rotation matrix is the inverse of said rotation matrix.</p>
<p>We can then use a Cholesky decomposition to extract</p>
<div class="arithmatex">\[
C = SM
\]</div>
<p>from <span class="arithmatex">\(B\)</span>.</p>
<p>Since the scale matrix is fully diagonal and the diagonal of a shear matrix is the identity we can compute them as follows:</p>
<div class="arithmatex">\[
M = diag \left( C \right)
\]</div>
<div class="arithmatex">\[
S = CM^{-1}
\]</div>
<p>Now to get the rotation matrix we can simply take:</p>
<div class="arithmatex">\[
R = AC^{-1} = R S M \left( SM \right) ^{-1}
\]</div>
<p>The rotation matrix can then be converted to a something like an euler angle sequence for further intuition.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>