
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../mds/">
      
      
        <link rel="next" href="../../transform/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.1">
    
    
      
        <title>cpd - Megham</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.45e1311d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#megham.registration.cpd" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Megham" class="md-header__button md-logo" aria-label="Megham" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Megham
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              cpd
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Megham" class="md-nav__button md-logo" aria-label="Megham" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Megham
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../joint_cpd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Joint CPD
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mds/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mds
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    registration
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            registration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    cpd
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    cpd
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#megham.registration.cpd" class="md-nav__link">
    <span class="md-ellipsis">
      cpd
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#megham.registration.cpd.Callback" class="md-nav__link">
    <span class="md-ellipsis">
      Callback
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#megham.registration.cpd.compute_P" class="md-nav__link">
    <span class="md-ellipsis">
      compute_P()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#megham.registration.cpd.cpd" class="md-nav__link">
    <span class="md-ellipsis">
      cpd()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#megham.registration.cpd.joint_cpd" class="md-nav__link">
    <span class="md-ellipsis">
      joint_cpd()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#megham.registration.cpd.solve_transform" class="md-nav__link">
    <span class="md-ellipsis">
      solve_transform()
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../transform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    transform
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#megham.registration.cpd" class="md-nav__link">
    <span class="md-ellipsis">
      cpd
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#megham.registration.cpd.Callback" class="md-nav__link">
    <span class="md-ellipsis">
      Callback
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#megham.registration.cpd.compute_P" class="md-nav__link">
    <span class="md-ellipsis">
      compute_P()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#megham.registration.cpd.cpd" class="md-nav__link">
    <span class="md-ellipsis">
      cpd()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#megham.registration.cpd.joint_cpd" class="md-nav__link">
    <span class="md-ellipsis">
      joint_cpd()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#megham.registration.cpd.solve_transform" class="md-nav__link">
    <span class="md-ellipsis">
      solve_transform()
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>cpd</h1>

<div class="doc doc-object doc-module">



<a id="megham.registration.cpd"></a>
  <div class="doc doc-contents first">
  
      <p>Module for performing coherent point drift</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h2 id="megham.registration.cpd.Callback" class="doc doc-heading">
          <code>Callback</code>


</h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="typing.Protocol">Protocol</span></code></p>

  
      <p>Callback idea shamelessly stolen from pycpd.</p>

            <details class="quote">
              <summary>Source code in <code>megham/registration/cpd.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Callback</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Callback idea shamelessly stolen from pycpd.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
        <span class="n">transformed</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
        <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">err</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>



<div class="doc doc-object doc-function">




<h2 id="megham.registration.cpd.compute_P" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">compute_P</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Compute matrix of probabilities of matches between points in source and target.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>source</code></td>
          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The set of source points to be mapped onto the target points.
Nominally when you run this it will be the source points transformed to line up with target.
Should have shape (nsrcpoints, ndim).</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>target</code></td>
          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The set of target points to be mapped onto.
Should have shape (ntrgpoints, ndim).</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>var</code></td>
          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The variance of the gaussian mixture model.
Should have shape (ndim,).</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>w</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The weight of the uniform distrubution.</p>
            </div>
          </td>
          <td>
                <code>0.0</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>P</code></td>          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Probability matrix of matches between the source and target points.
P[i,j] is the probability that source[i] corresponds to target[j].
Has shape (nsrcpoints, ntrgpoints).</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>megham/registration/cpd.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_P</span><span class="p">(</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">var</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">w</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute matrix of probabilities of matches between points in source and target.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source : NDArray[np.floating]</span>
<span class="sd">        The set of source points to be mapped onto the target points.</span>
<span class="sd">        Nominally when you run this it will be the source points transformed to line up with target.</span>
<span class="sd">        Should have shape (nsrcpoints, ndim).</span>
<span class="sd">    target : NDArray[np.floating]</span>
<span class="sd">        The set of target points to be mapped onto.</span>
<span class="sd">        Should have shape (ntrgpoints, ndim).</span>
<span class="sd">    var : NDArray[np.floating]</span>
<span class="sd">        The variance of the gaussian mixture model.</span>
<span class="sd">        Should have shape (ndim,).</span>
<span class="sd">    w : float, default: 0.0</span>
<span class="sd">        The weight of the uniform distrubution.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    P : NDArray[np.floating]</span>
<span class="sd">        Probability matrix of matches between the source and target points.</span>
<span class="sd">        P[i,j] is the probability that source[i] corresponds to target[j].</span>
<span class="sd">        Has shape (nsrcpoints, ntrgpoints).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: implement fast gaussian transform</span>
    <span class="n">nsrcpoints</span><span class="p">,</span> <span class="n">ndim</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ntrgpoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="n">uni</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w</span><span class="p">))</span>
        <span class="o">*</span> <span class="p">(</span><span class="n">nsrcpoints</span> <span class="o">/</span> <span class="n">ntrgpoints</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="n">ndim</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">gaussians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nsrcpoints</span><span class="p">,</span> <span class="n">ntrgpoints</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
        <span class="n">sq_diff</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">source</span><span class="p">[:,</span> <span class="n">dim</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">target</span><span class="p">[:,</span> <span class="n">dim</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;sqeuclidean&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">gaussians</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">sq_diff</span> <span class="o">/</span> <span class="n">var</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span>
    <span class="n">norm_fac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gaussians</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">epsilon</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">gaussians</span> <span class="o">/</span> <span class="p">(</span><span class="n">norm_fac</span> <span class="o">+</span> <span class="n">uni</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">P</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="megham.registration.cpd.cpd" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cpd</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">dummy_callback</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;affine&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Compute the CPD.
This is just a wrapper around joint_cpd that puts everything into one dim_group.
See the docstring of joint_cpd for details on the parameters and returns.</p>
<p>See https://arxiv.org/abs/0905.2635 for details on the base CPD algorithm.</p>

          <details class="quote">
            <summary>Source code in <code>megham/registration/cpd.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">cpd</span><span class="p">(</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">w</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">,</span>
    <span class="n">max_iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
    <span class="n">callback</span><span class="p">:</span> <span class="n">Callback</span> <span class="o">=</span> <span class="n">dummy_callback</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;affine&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
    <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the CPD.</span>
<span class="sd">    This is just a wrapper around joint_cpd that puts everything into one dim_group.</span>
<span class="sd">    See the docstring of joint_cpd for details on the parameters and returns.</span>

<span class="sd">    See https://arxiv.org/abs/0905.2635 for details on the base CPD algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">joint_cpd</span><span class="p">(</span>
        <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
        <span class="n">dim_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
        <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
        <span class="n">max_iters</span><span class="o">=</span><span class="n">max_iters</span><span class="p">,</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="megham.registration.cpd.joint_cpd" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">joint_cpd</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">dim_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">dummy_callback</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;affine&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Compute the joint CPD.</p>
<p>This is an extension of the base CPD algorithm that allows you to fit for
transforms that treat groups of dimensions seperately but use a jointly computed
probability matrix and variance.
This is useful in cases where you have information about a set of points that is correlated
but in a different basis so you want to avoid degrees of freedom that mix the disprate baseis.
For example if you have a set of points where you have both spatial information as well as some
non-spatial scalar associated with each point (ie: frequency) you can use this to compute a
registration that considers these jointly but transforms them seperately to avoid a scenario
where you have a rotation between a spatial and a non-spatial dimension.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>source</code></td>
          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The set of source points to be mapped onto the target points.
Should have shape (nsrcpoints, ndim).</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>target</code></td>
          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The set of target points to be mapped onto.
Should have shape (ntrgpoints, ndim).</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dim_groups</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Sequence">Sequence</span>[<span title="typing.Sequence">Sequence</span>[int] | <span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.int_">int_</span>]]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Which dimensions should be transformed together.
Each element in this sequence should be a sequence of array of ints that correspond to the
columns of source and target that are transformed together.
Any columns that are not included here will not be transformed but will still be used when
computing the probability and variance.
None of the elements in this sequence can have overlap.
If set to None all the dimensions will be transformed together.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>w</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The weight of the uniform distrubution.
Set higher to reduce sensitivity to noise and outliers at the expense
of potentially worse performance.
Should be in the range [0, 1), if not it will snap to one of the bounds.</p>
            </div>
          </td>
          <td>
                <code>0.0</code>
          </td>
        </tr>
        <tr>
          <td><code>eps</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The convergence criteria.
When the change in the objective function is less than or equal to this we stop.</p>
            </div>
          </td>
          <td>
                <code>1e-10</code>
          </td>
        </tr>
        <tr>
          <td><code>max_iters</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The maximum number of iterations to run for.</p>
            </div>
          </td>
          <td>
                <code>500</code>
          </td>
        </tr>
        <tr>
          <td><code>callback</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="megham.registration.cpd.Callback" href="#megham.registration.cpd.Callback">Callback</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Function that runs once per iteration, can be used to visualize the match process.
See the Callback Protocol for details on the expected signature.</p>
            </div>
          </td>
          <td>
                <code><span title="megham.registration.cpd.dummy_callback">dummy_callback</span></code>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The type of transformation to compute.
Acceptable values are: affine, rigid.
If any other value is passed then transform will be the identity.</p>
            </div>
          </td>
          <td>
                <code>&#39;affine&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>transform</code></td>          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The transform transformation that takes source to target.
Apply using megham.transform.apply_transform.
Has shape (ndim, ndim).</p>
            </div>
          </td>
        </tr>
        <tr>
<td><code>shift</code></td>          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The transformation that takes source to target after transform is applied.
Apply using megham.transform.apply_transform.
Has shape (ndim,).</p>
            </div>
          </td>
        </tr>
        <tr>
<td><code>transformed</code></td>          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Source transformed to align with target.
Has shape (nsrcpoints, ndim).</p>
            </div>
          </td>
        </tr>
        <tr>
<td><code>P</code></td>          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Probability matrix of matches between the source and target points.
P[i,j] is the probability that source[i] corresponds to target[j].
Has shape (nsrcpoints, ntrgpoints).</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>ValueError</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If source and target don't share ndim.
If dim_groups has repeated dimensions or invalid dimensions.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>megham/registration/cpd.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">joint_cpd</span><span class="p">(</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">dim_groups</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">w</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-10</span><span class="p">,</span>
    <span class="n">max_iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
    <span class="n">callback</span><span class="p">:</span> <span class="n">Callback</span> <span class="o">=</span> <span class="n">dummy_callback</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;affine&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
    <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the joint CPD.</span>

<span class="sd">    This is an extension of the base CPD algorithm that allows you to fit for</span>
<span class="sd">    transforms that treat groups of dimensions seperately but use a jointly computed</span>
<span class="sd">    probability matrix and variance.</span>
<span class="sd">    This is useful in cases where you have information about a set of points that is correlated</span>
<span class="sd">    but in a different basis so you want to avoid degrees of freedom that mix the disprate baseis.</span>
<span class="sd">    For example if you have a set of points where you have both spatial information as well as some</span>
<span class="sd">    non-spatial scalar associated with each point (ie: frequency) you can use this to compute a</span>
<span class="sd">    registration that considers these jointly but transforms them seperately to avoid a scenario</span>
<span class="sd">    where you have a rotation between a spatial and a non-spatial dimension.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source : NDArray[np.floating]</span>
<span class="sd">        The set of source points to be mapped onto the target points.</span>
<span class="sd">        Should have shape (nsrcpoints, ndim).</span>
<span class="sd">    target : NDArray[np.floating]</span>
<span class="sd">        The set of target points to be mapped onto.</span>
<span class="sd">        Should have shape (ntrgpoints, ndim).</span>
<span class="sd">    dim_groups : Optional[Sequence[Sequence[int] | NDArray[np.int_]]], default: None</span>
<span class="sd">        Which dimensions should be transformed together.</span>
<span class="sd">        Each element in this sequence should be a sequence of array of ints that correspond to the</span>
<span class="sd">        columns of source and target that are transformed together.</span>
<span class="sd">        Any columns that are not included here will not be transformed but will still be used when</span>
<span class="sd">        computing the probability and variance.</span>
<span class="sd">        None of the elements in this sequence can have overlap.</span>
<span class="sd">        If set to None all the dimensions will be transformed together.</span>
<span class="sd">    w : float, default: 0.0</span>
<span class="sd">        The weight of the uniform distrubution.</span>
<span class="sd">        Set higher to reduce sensitivity to noise and outliers at the expense</span>
<span class="sd">        of potentially worse performance.</span>
<span class="sd">        Should be in the range [0, 1), if not it will snap to one of the bounds.</span>
<span class="sd">    eps : float, default: 1e-10</span>
<span class="sd">        The convergence criteria.</span>
<span class="sd">        When the change in the objective function is less than or equal to this we stop.</span>
<span class="sd">    max_iters : int, default: 500</span>
<span class="sd">        The maximum number of iterations to run for.</span>
<span class="sd">    callback: Callback, default: dummy_callback</span>
<span class="sd">        Function that runs once per iteration, can be used to visualize the match process.</span>
<span class="sd">        See the Callback Protocol for details on the expected signature.</span>
<span class="sd">    method : str, default: &#39;affine&#39;</span>
<span class="sd">        The type of transformation to compute.</span>
<span class="sd">        Acceptable values are: affine, rigid.</span>
<span class="sd">        If any other value is passed then transform will be the identity.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    transform : NDArray[np.floating]</span>
<span class="sd">        The transform transformation that takes source to target.</span>
<span class="sd">        Apply using megham.transform.apply_transform.</span>
<span class="sd">        Has shape (ndim, ndim).</span>
<span class="sd">    shift : NDArray[np.floating]</span>
<span class="sd">        The transformation that takes source to target after transform is applied.</span>
<span class="sd">        Apply using megham.transform.apply_transform.</span>
<span class="sd">        Has shape (ndim,).</span>
<span class="sd">    transformed : NDArray[np.floating]</span>
<span class="sd">        Source transformed to align with target.</span>
<span class="sd">        Has shape (nsrcpoints, ndim).</span>
<span class="sd">    P : NDArray[np.floating]</span>
<span class="sd">        Probability matrix of matches between the source and target points.</span>
<span class="sd">        P[i,j] is the probability that source[i] corresponds to target[j].</span>
<span class="sd">        Has shape (nsrcpoints, ntrgpoints).</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If source and target don&#39;t share ndim.</span>
<span class="sd">        If dim_groups has repeated dimensions or invalid dimensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ndim</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Source and target don&#39;t have same ndim (</span><span class="si">{</span><span class="n">ndim</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">dim_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dim_groups</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ndim</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dims_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dim_groups</span><span class="p">)</span>
        <span class="n">dims_bad</span> <span class="o">=</span> <span class="n">dims_flat</span><span class="p">[(</span><span class="n">dims_flat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dims_flat</span> <span class="o">&gt;=</span> <span class="n">ndim</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims_bad</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid dimensions in dim_groups: </span><span class="si">{</span><span class="n">dims_bad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">dims_uniq</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dims_flat</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">repeats</span> <span class="o">=</span> <span class="n">dims_uniq</span><span class="p">[</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">repeats</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Repeated dimensions in dim_groups: </span><span class="si">{</span><span class="n">repeats</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">dim_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dim_group</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim_group</span> <span class="ow">in</span> <span class="n">dim_groups</span><span class="p">]</span>

    <span class="n">var</span> <span class="o">=</span> <span class="n">_init_var</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">dim_groups</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="n">transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>

    <span class="n">transformed</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iters</span><span class="p">):</span>
        <span class="n">_err</span><span class="p">,</span> <span class="n">_transform</span><span class="p">,</span> <span class="n">_shift</span> <span class="o">=</span> <span class="n">err</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">shift</span>
        <span class="n">transformed</span> <span class="o">=</span> <span class="n">apply_transform</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">compute_P</span><span class="p">(</span><span class="n">transformed</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">transform</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">solve_transform</span><span class="p">(</span>
            <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">dim_groups</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">method</span>
        <span class="p">)</span>
        <span class="n">callback</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">transformed</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_err</span> <span class="o">-</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span> <span class="o">&gt;</span> <span class="n">_err</span><span class="p">:</span>
                <span class="n">transform</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">_transform</span><span class="p">,</span> <span class="n">_shift</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">transform</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">transformed</span><span class="p">,</span> <span class="n">P</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="megham.registration.cpd.solve_transform" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">solve_transform</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">dim_groups</span><span class="p">,</span> <span class="n">cur_var</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;affine&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Solve for the transformation at each iteration of CPD.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>source</code></td>
          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The set of source points to be mapped onto the target points.
Should have shape (nsrcpoints, ndim).</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>target</code></td>
          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The set of target points to be mapped onto.
Should have shape (ntrgpoints, ndim).</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>P</code></td>
          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Probability matrix of matches between the source and target points.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dim_groups</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[<span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.int_">int_</span>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Which dimensions should be transformed together.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cur_var</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The current mixture model variance.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>method</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The type of transformation to compute.
Acceptable values are: affine, rigid.
If any other value is passed then transform will be the identity.</p>
            </div>
          </td>
          <td>
                <code>&#39;affine&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>transform</code></td>          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Transformation between source and target.</p>
            </div>
          </td>
        </tr>
        <tr>
<td><code>shift</code></td>          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Shift to be applied after the affine transformation.</p>
            </div>
          </td>
        </tr>
        <tr>
<td><code>var</code></td>          <td>
                <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Current variance of the mixture model.</p>
            </div>
          </td>
        </tr>
        <tr>
<td><code>err</code></td>          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Current value of the error function.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>megham/registration/cpd.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">solve_transform</span><span class="p">(</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">P</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">dim_groups</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">]],</span>
    <span class="n">cur_var</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;affine&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve for the transformation at each iteration of CPD.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source : NDArray[np.floating]</span>
<span class="sd">        The set of source points to be mapped onto the target points.</span>
<span class="sd">        Should have shape (nsrcpoints, ndim).</span>
<span class="sd">    target : NDArray[np.floating]</span>
<span class="sd">        The set of target points to be mapped onto.</span>
<span class="sd">        Should have shape (ntrgpoints, ndim).</span>
<span class="sd">    P : NDArray[np.floating]</span>
<span class="sd">        Probability matrix of matches between the source and target points.</span>
<span class="sd">    dim_groups : Sequence[NDArray[np.int_]]</span>
<span class="sd">        Which dimensions should be transformed together.</span>
<span class="sd">    cur_var : float</span>
<span class="sd">        The current mixture model variance.</span>
<span class="sd">    method : str, default: &#39;affine&#39;</span>
<span class="sd">        The type of transformation to compute.</span>
<span class="sd">        Acceptable values are: affine, rigid.</span>
<span class="sd">        If any other value is passed then transform will be the identity.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    transform : NDArray[np.floating]</span>
<span class="sd">        Transformation between source and target.</span>
<span class="sd">    shift : NDArray[np.floating]</span>
<span class="sd">        Shift to be applied after the affine transformation.</span>
<span class="sd">    var : NDArray[np.floating]</span>
<span class="sd">        Current variance of the mixture model.</span>
<span class="sd">    err : float</span>
<span class="sd">        Current value of the error function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">N_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">PT1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">mu_src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">source</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">N_P</span>
    <span class="n">mu_trg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">P</span> <span class="o">@</span> <span class="n">target</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">N_P</span>

    <span class="n">src_hat</span> <span class="o">=</span> <span class="n">source</span> <span class="o">-</span> <span class="n">mu_src</span>
    <span class="n">trg_hat</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">mu_trg</span>

    <span class="n">transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>
    <span class="n">new_var</span> <span class="o">=</span> <span class="n">cur_var</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">dim_group</span> <span class="ow">in</span> <span class="n">dim_groups</span><span class="p">:</span>
        <span class="n">mu_s</span> <span class="o">=</span> <span class="n">mu_src</span><span class="p">[</span><span class="n">dim_group</span><span class="p">]</span>
        <span class="n">mu_t</span> <span class="o">=</span> <span class="n">mu_trg</span><span class="p">[</span><span class="n">dim_group</span><span class="p">]</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">src_hat</span><span class="p">[:,</span> <span class="n">dim_group</span><span class="p">]</span>
        <span class="n">trg</span> <span class="o">=</span> <span class="n">trg_hat</span><span class="p">[:,</span> <span class="n">dim_group</span><span class="p">]</span>

        <span class="n">all_mul</span> <span class="o">=</span> <span class="n">trg</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">P</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">src</span>
        <span class="n">src_mul</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">P1</span> <span class="o">@</span> <span class="n">src</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;affine&quot;</span><span class="p">:</span>
            <span class="n">tfm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">src_mul</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">all_mul</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;rigid&quot;</span><span class="p">:</span>
            <span class="n">U</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">all_mul</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dim_group</span><span class="p">))</span>
            <span class="n">corr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">((</span><span class="n">V</span><span class="p">)</span> <span class="o">@</span> <span class="p">(</span><span class="n">U</span><span class="p">))</span>
            <span class="n">tfm</span> <span class="o">=</span> <span class="n">U</span> <span class="o">@</span> <span class="n">corr</span> <span class="o">@</span> <span class="n">V</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tfm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>

        <span class="n">sft</span> <span class="o">=</span> <span class="n">mu_t</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">tfm</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">mu_s</span><span class="o">.</span><span class="n">T</span>

        <span class="n">transform</span><span class="p">[</span><span class="n">dim_group</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">dim_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">tfm</span>
        <span class="n">shift</span><span class="p">[</span><span class="n">dim_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">sft</span>

        <span class="n">trc_trf_mul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">tfm</span> <span class="o">@</span> <span class="n">src_mul</span> <span class="o">@</span> <span class="n">tfm</span><span class="p">)</span>
        <span class="n">trc_trg_mul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">trg</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">PT1</span> <span class="o">@</span> <span class="n">trg</span><span class="p">)</span>
        <span class="n">trc_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">all_mul</span> <span class="o">@</span> <span class="n">tfm</span><span class="p">)</span>

        <span class="n">var</span> <span class="o">=</span> <span class="p">(</span><span class="n">trc_trg_mul</span> <span class="o">-</span> <span class="n">trc_all</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">N_P</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim_group</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">var</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">epsilon</span>
        <span class="n">new_var</span><span class="p">[</span><span class="n">dim_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>

        <span class="n">err</span> <span class="o">+=</span> <span class="p">(</span><span class="n">trc_trg_mul</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">trc_all</span> <span class="o">+</span> <span class="n">trc_trf_mul</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">cur_var</span><span class="p">[</span><span class="n">dim_group</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">N_P</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim_group</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">cur_var</span><span class="p">[</span><span class="n">dim_group</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">transform</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">new_var</span><span class="p">,</span> <span class="n">err</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>